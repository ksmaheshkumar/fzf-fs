#!/usr/bin/env bash
__fzf_fs_console_console () 
{ 
    builtin unset -v chars count files matches query selection strings;
    builtin typeset -i count;
    builtin typeset -a chars files matches query selection strings;
    console[2]=1;
    files=($(
                                command find -H "${FZF_FS_CONFIG_DIR}/sessions/${FZF_FS_SESSION}/bin/console/." ! -name . |
                                command sed "s#^${FZF_FS_CONFIG_DIR}/sessions/${FZF_FS_SESSION}/bin/console/./##" |
                                command sort -u
                        ));
    while [[ -n "${console[3]}" ]]; do
        selection=($(
                                        command printf '%s\n' "${files[@]}" |
                                        command fzf -x +s --print-query --prompt=":" --expect="ctrl-i" --query="$query"
                                ));
        if [[ -n "${selection[0]}" && "${selection[1]}" == "ctrl-i" ]]; then
            matches=($(
                                                command printf '%s\n' "${files[@]}" |
                                                command grep -e "^${selection[0]}"
                                        ));
            if ((${#matches[@]} > 1)); then
                count=0;
                strings=(${matches[@]#${selection[0]}});
                chars=();
                while [[ -n "${strings[0]}" ]]; do
                    for i in "${!strings[@]}";
                    do
                        chars[$i]="${strings[$i]:0:1}";
                    done;
                    if [[ -z "$(command printf '%s' "${chars[@]//${chars[0]}}")" ]]; then
                        count+=1;
                        for i in "${!strings[@]}";
                        do
                            strings[$i]="${strings[$i]#${chars[$i]}}";
                        done;
                    else
                        strings[0]=;
                    fi;
                done;
                if ((count == 0)); then
                    query="${selection[0]}";
                else
                    query="${matches[0]:0:${#selection[0]}+count}";
                fi;
            else
                if ((${#matches[@]} == 1)); then
                    query="${matches[0]}";
                else
                    query="${selection[0]}";
                fi;
            fi;
            builtin continue;
        else
            if [[ "${selection[0]}" == "ctrl-i" ]]; then
                query=;
                builtin continue;
            else
                if [[ -n "${selection[0]}" && -n "${selection[1]}" ]]; then
                    console[3]="${selection[1]}";
                else
                    console[3]="${selection[0]}";
                fi;
                query=;
            fi;
        fi;
        console[0]="${FZF_FS_CONFIG_DIR}/sessions/${FZF_FS_SESSION}/bin/console/${console[3]}";
        [[ -f "${console[0]}" ]] && builtin eval . "${console[0]}";
    done;
    console[2]=0
}
__fzf_fs_console_console "$@";
builtin unset -f __fzf_fs_console_console
